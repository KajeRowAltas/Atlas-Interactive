Webhook (new message from you or any interface)
└──> Set Session ID (if new) + Load/Create ShortTermMemory doc
└──> Query Analysis Agent (HTTP + OpenAI/Llama3 structured output)
     └──> MongoDB: Insert QueryAnalysis + append human message to ChatHistories
└──> Response Agent (big context prompt with RAG retrievals)
     └──> Several parallel MongoDB finds:
          - Vector search SemanticMemories + VectorMemoryChunks (top 6-10)
          - Top ProceduralMemories by success_rate for detected intent
          - CurrentEmotionalState + PersonalityTraits + Goals
          - Last 15-20 messages from ChatHistories
     └──> Generate response → append AI message to ChatHistories
     └──> (Optional) Tool execution → ActivityLog + ProjectTasks
└──> Return response to user/interface
└──> [Split] → Trigger Reflection Agent (can be same workflow with “Wait” or separate workflow via webhook)
     └──> Reflection Agent (prompt: “extract insights, trait drift, new beliefs, mood, procedural improvements…”)
          → Multiple MongoDB updates (findOneAndUpdate with $inc, $set, $push)

[User Input] 
    ↓
┌─────────────────────┐
│ 1. Query Analysis   │ → writes to: QueryAnalysis + ChatHistories (new message) + ShortTermMemory (session context)
└─────────────────────┘
    ↓ (parsed intent, entities, emotion cues, suggested tools/routes)
┌─────────────────────┐
│ 2. Response Agent   │ → reads: AgentProfile, PersonalityTraits, GoalsValuesBeliefs, 
│                       │   Semantic/Knowledge/Procedural/Episodic memories (via vector + classic lookup), 
│                       │   CurrentEmotionalState, ShortTermMemory (session), ChatHistories (context window)
│                       │ → writes: final response to ChatHistories, updates ShortTermMemory, 
│                       │   optionally triggers tools → ActivityLog + ProjectTasks if actions taken
└─────────────────────┘
    ↓
[Response sent to user + internal copy kept]
    ↓
┌─────────────────────┐
│ 3. Reflection Agent  │ → triggers asynchronously (can be immediate or delayed 5–30 sec)
│   (self-improvement) │ → reads: last QueryAnalysis, full turn from ChatHistories, 
│                       │   ActivityLog (if tools were used), CurrentEmotionalState
│                       │ → writes / updates:
│       • ReflectionsInsights (new insights, strength score)
│       • PersonalityTraits (tiny nudges if drift detected)
│       • GoalsValuesBeliefs (priority/strength tweaks)
│       • CurrentEmotionalState (new mood after interaction)
│       • EmotionalHistory log
│       • ProceduralMemories (if a new procedure worked well → bump success_rate)
│       • SemanticMemories / KnowledgeMemories (new facts or rules learned)
└─────────────────────┘
    ↓
→ Loop closes. Next user message starts again from step 1 with richer memory & slightly evolved agent.
